name: Deploy to VPS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to VPS
      run: |
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          echo "ðŸš€ Starting deployment..."
          
          # Navigate to project directory
          cd /opt/rust-selfhost-server || {
            echo "âŒ Project directory not found. Please clone the repository first:"
            echo "   git clone https://github.com/a-ariff/rust-selfhost-server.git /opt/rust-selfhost-server"
            exit 1
          }
          
          # Pull latest changes
          echo "ðŸ“¦ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          # Update containers
          echo "ðŸ³ Updating Docker containers..."
          docker compose pull
          
          # Restart services
          echo "ðŸ”„ Restarting services..."
          docker compose up -d
          
          # Wait for services to be healthy
          echo "â³ Waiting for services to start..."
          sleep 10
          
          # Check service status
          echo "âœ… Checking service status..."
          docker compose ps
          
          echo "ðŸŽ‰ Deployment completed successfully!"
        EOF
        
    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment..."
        # Basic connectivity test (optional)
        # curl -f -s -o /dev/null https://${DOMAIN} && echo "âœ… Service is responding" || echo "âš ï¸  Service health check failed"
        echo "â„¹ï¸  Deployment verification completed. Please check your domain manually."
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Your application should be available at your configured domain"
          echo "ðŸ“Š Check Traefik dashboard for routing status"
        else
          echo "âŒ Deployment failed!"
          echo "ðŸ” Check the logs above for error details"
          echo "ðŸ”§ Common issues:"
          echo "   - SSH connection problems"
          echo "   - Missing environment variables (.env file)"
          echo "   - Docker/Docker Compose not installed"
          echo "   - Insufficient permissions"
        fi
